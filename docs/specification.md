# DEFCHR TOOL for Web 仕様書

## 概要

DEFCHR TOOLは、1980年代の8bitコンピューターであるSHARP X1のシステムディスクに収録されていたPCGエディタである。

PCGとはProgrammable Character Generatorの略で、X1においてはテキスト文字に任意のグラフィックキャラクター(8x8の8色で構成されるもの)を割り当てられる機能を指し、PCGエディタとは、そのPCG画像を編集するためのグラフィックエディタである。

キャラクターコード0〜255の256種類の文字に画像を割り当てられ、R,G,Bの3色のグラフィックスプレーンを重ねて8色を表現する、当時よくあった形式でのデータ出力が可能。

DEFCHR TOOL for Webは、そのDEFCHR TOOLをWeb版に移植したものである。

## 画面構成

![DEFCHR TOOLメイン画面](images/DEFCHR%20TOOL3.png)

これがDEFCHR TOOLのメイン画面である。

- 最上部にCharacter makerというタイトル
- 左側に編集エリア(8x8の文字を2x2で4文字ぶん編集出来る)
- 右側に256文字ぶんのPCGの定義状況表示
- 下部に編集メニュー(指定キーの入力でメニューに切り替わる)

このような構成になっており、右下には現在編集中の画像が実サイズで表示されている。

X1の画面は基本的には8x8ドットが1文字で、その文字が40x25並ぶ、320x200ドットの画面(いわゆるWIDTH 40)が基本となっているが、編集モード切り替えで、80x25 = 640x200ドットのモード(いわゆるWIDTH 80)にも切り替えられる。WIDTH 80の時はドットが縦長になり、横方向の解像度が上がる。ツールの編集画面構成は変わらず、単純に640x200の画面の左側の320x200に、そのまま縦長で編集画面が表示されるのみとなる(右半分は真っ黒である)。

## 編集方法

画面構成のスクリーンショットの編集エリアでは見えていないが、左側の編集エリアには編集可能な状態においてはカーソルが点滅表示されている。カーソル形状は白い四角で、8x8サイズとなる。

カーソルはカーソルキーで編集エリア内を自由に移動できる。カーソル移動が行われた場合、画面下部のCURSOR MOVEの左側の「→←↑↓」の移動した方向の矢印の文字が赤くなる。これは「現在の移動方向」を示す。

数字キーで0〜7までの文字を入力すると、それぞれの文字に対応した色でカーソルの下にある部分のドットを描画出来る。画面構成における「●」の表示が、ドットが打たれた状態を示している。この時、カーソルキーで最後に移動した「現在の移動方向」にカーソルが1つ進む。これにより、例えば下に移動してから「1」を入力すると、1の色を下方向に1ドットずつ描画していく事が出来る。枠の端まで移動すると折り返される事はなく、それ以上カーソルは進まなくなる。
また、ドット消去は特別なキーがあるわけではなく、単に「0」で透明色に書き換える事でそのドットを消す事が出来る。

## EDIT MODE

Mキーを押してEDIT MODEを選ぶと、下記の画面が表示される。

![EDIT MODE画面](images/EDIT%20MODE.png)

EDIT MODEでは、編集画面の2x2の編集エリアをどのように扱うかを設定出来る。
それぞれ以下のような意味となる。

- 0..4Chr.ベツベツ
  - これは2x2の編集エリアの文字を無関係の4文字分として扱うモードである。例えば8x8のフォントなどを編集する場合にこのモードを使う。
- 1..タテ2Chr.
  - 2x2のエリアの1x2エリアを縦に2文字分として編集エリアを使うモードである。
- 2..ヨコ2Chr.
  - 2x2のエリアの2x1エリアを横に2文字分として編集エリアを使うモードである。
- 3..4Chr.スベテ
  - 2x2のエリアの4文字分を1つの画像として扱うモードである。16x16の大きな画像を編集する時などに使う。
- 4〜9..これらのメニューはWeb版では未実装とする。

編集モードを切り替えても、その時には特に何も起きず、EDIT CHR.やSET CHR.の時に編集モードが反映される(後述する)。

## EDIT CHR.

Eキーを押してEDIT CHR.を選ぶと、下記の画面が表示される。

![EDIT CHR.画面](images/EDIT%20CHR%201.png)

この状態で0を選ぶと、ROMにあるフォントデータを読み込んで編集エリアに表示し、1を選ぶと、PCGの画像データを読み込んで編集エリアに表示する。2はWeb版では未実装とする。

![EDIT CHR.画面](images/EDIT%20CHR%202.png)

上記は0..ROMCGを選んだ時の画面で、これは、1..RAMCGを選んでも同様に「Edit character code=&h」という入力欄が画面下部に表示される。ここで文字コードを入力する事で、その文字コードに対応したフォントデータやPCGの画像データを編集エリアに表示する事が出来る。

この時に先程のEDIT MODEで設定した編集モードが反映され、それぞれ下記の挙動となる。

- 0..4Chr.ベツベツ
  - カーソルが編集エリアの2x2のどの位置にあるかによって変わるが、例えば右上のエリアにある場合、その右上のエリアのみに反映される。つまりROMCGの&h41を指定した場合、ROMCGモードではその文字画像(「A」)が、RAMCGモードではPCGの画像が取得され、編集エリアの右上の8x8のエリアに表示される。
- 1..タテ2Chr.
  - これもカーソルが編集エリアの2x2のどの位置にあるかによって変わるが、例えば右側のエリアにある場合、その右側のエリアのみに反映される。つまりROMCGの&h41を指定した場合、ROMCGモードではその文字画像(「A」)が、RAMCGモードではPCGの画像が取得され、編集エリアの右上に、次に&h51の文字(「Q」)のフォントデータが編集エリアの右下に表示される(&h42ではなく&h51になるので注意)
- 2..ヨコ2Chr.
  - これもカーソルが編集エリアの2x2のどの位置にあるかによって変わるが、例えば下側のエリアにある場合、その下側のエリアのみに反映される。つまりROMCGの&h41を指定した場合、ROMCGモードではその文字画像(「A」)が、RAMCGモードではPCGの画像が取得され、編集エリアの左下に表示され、次に&h42の文字画像(「B」)が編集エリアの右下に表示される。
- 3..4Chr.スベテ
  - これは2x2の4文字を全て反映させるモードなので、カーソル位置に関わらず、&h41を指定した場合は左上が&h41の文字(画像)、右上が&h42の文字(画像)、左下が&h51の文字(画像)、右下が&h52の文字(画像)として表示される。

若干ややこしく感じるが、横方向の取得は文字コード+1で処理され、縦方向の取得は+&h10(10進数で16)で処理される。

ROMCGは文字キャラクターROMからデータが取得され、RAMCGはPCGの画像データが取得される。

## SET CHR.

Sキーを押してSET CHR.を選ぶと、画面下部に「Set character code=&h」という入力欄が表示される。ここで文字コードを入力する事で、現在編集画面にある画像を、該当の文字コードに対応したキャラクターに定義出来る。

これもまたEDIT MODEで設定した編集モードが反映され、それぞれ下記の挙動となる。

- 0..4Chr.ベツベツ
  - カーソルが編集エリアの2x2のどの位置にあるかによって変わるが、例えば右上のエリアにある場合、その右上のエリアのみに反映される。つまりROMCGの&h41を指定した場合、編集エリアの右上の画像が1文字ぶんだけ、右側のエリアの&h41の部分に定義される
- 1..タテ2Chr.
  - カーソルが編集エリアの2x2のどの位置にあるかによって変わるが、例えば右側のエリアにある場合、その右側のエリアのみに反映される。つまりROMCGの&h41を指定した場合、編集エリアの右上と右下のそれぞれの文字が、右側の定義エリアの&h41と&h51の位置に定義される
- 2..ヨコ2Chr.
  - カーソルが編集エリアの2x2のどの位置にあるかによって変わるが、例えば下側のエリアにある場合、その下側のエリアのみに反映される。つまりROMCGの&h41を指定した場合、編集エリアの左下と右下のそれぞれの文字が、下側の定義エリアの&h41と&h42の位置に定義される
- 3..4Chr.スベテ
  - これは2x2の4文字を全て定義するモードなので、カーソル位置に関わらず、&h41を指定した場合は左上が&h41の文字(画像)、右上が&h42の文字(画像)、左下が&h51の文字(画像)、右下が&h52の文字(画像)として定義される。

SET CHRはあくまで現在編集している画像を右側の定義エリアにコピーするような挙動であるため、SET対象としてROMやRAMなどを選ぶモード選択は存在しない。

## ROTATION

Rキーを押してROTATIONを選ぶと、下記の画面が表示される。

![ROTATION画面](images/ROTATION.png)

この画面では、現在編集している画像を移動、反転、回転させることが出来る(ROTATIONという名前だが、なぜか移動や反転もこのメニューで行う)

- 0..Right
  - →1ドット左に移動させる。左端にはみでた部分は右側に折り返される。
  - 移動エリアは「EDIT MODE」で設定した編集モードに応じて変わる。
- 1..Left
  - ←1ドット右に移動させる。右端にはみでた部分は左側に折り返される。
  - 移動エリアは「EDIT MODE」で設定した編集モードに応じて変わる。
- 2..Up
  - ↑1ドット上に移動させる。上端にはみでた部分は下側に折り返される。
  - 移動エリアは「EDIT MODE」で設定した編集モードに応じて変わる。
- 3..Down
  - ↓1ドット下に移動させる。下端にはみでた部分は上側に折り返される。
  - 移動エリアは「EDIT MODE」で設定した編集モードに応じて変わる。
- 4..90°
  - 90度半時計回りに回転させる。
  - これも回転するエリアは「EDIT MODE」で設定した編集モードに応じて変わる。
  - ただし、タテ2Chr.やヨコ2Chr.モードの場合は選んでも何も起きない
- 5..180°
  - 180度に回転させる。
  - これも回転するエリアは「EDIT MODE」で設定した編集モードに応じて変わる。
  - ただし、タテ2Chr.やヨコ2Chr.モードの場合は選んでも何も起きない
- 6..─
  - 上下フリップする
  - これもフリップするエリアは「EDIT MODE」で設定した編集モードに応じて変わる。
- 7..|
  - 左右フリップする
  - これもフリップするエリアは「EDIT MODE」で設定した編集モードに応じて変わる。


## TRANSFER

Tキーを押してTRANSFERを選ぶと、下記の画面が表示される。

![TRANSFER画面](images/TRANSFER.png)

これは、右側の定義エリアの画像を別の場所にコピーするモードである。

「TRANSFER HEX CODE(S,E,T)=」と表示され、Sは開始位置、Eは終了位置、Tは転送(コピー)開始位置のASCIIコードである。
例えば画面のように60,61,63とすると、&60から&h61までの2文字が、&h63から&h64までの2文字にコピーされる。


## PROGRAMMING

PのPROGRAMMINGを選ぶと、

```
## DEFCHR Programming ##
FILENAME=
```

という表示がされ、ファイルネームの入力が促される。ここでファイルネームを入力すると、そのファイル名のファイルにDEFCHRのデータが書き込まれる。
ファイル形式はASCII形式で、X1のBASICで使える形式となる。

```
60960 DEFCHR$(96)=HEXCHR$("FF80909090909080FF80808080808080FF80808080808080")
```

DEFCHR$の引数は文字コードであるが、HEXCHR$については、BRGの各プレーンの定義となる。
つまり1ビット1ドットで、BRGのプレーンを重ねて色を定義し、8色を表現する。

Web版では一応この形式での出力も可能にするが、この他にバイナリ出力モード、3倍速定義バイナリ出力モードを搭載する。

X1のPCGのフォーマットについては、通常の画像をPCG形式に変換するツールが、

https://github.com/h-o-soft/x1pcgconv

に、あるので、このツールの実装を参考にする事。

## 本ツールで使う文字

Web版においては、

https://github.com/meister68k/X1_compatible_font

上記にあるX1互換フォントを使って画面を構成する事。つまり、通常の文字としてUIを構築するのではなく、全てこの画像を使って表現する必要があるので、どのような方式で画面を描画するかは事前に検討が必要になる。

WIDTH 40とWIDTRH 80での描画の問題もあるので、オフスクリーン描画したビットマップを利用して、それを画面に描画するような方式を採用するのが良いかもしれない(これはアーキテクチャ設計の段階で検討する)。

## Web版での拡張

### マウスモード
Web版ではマウス操作による編集も可能にする。

この320x200(または640x200)の画面外に「マウスモード」の切り替えボタンを設置して、そのボタンでマウスモードとする事で、下記の操作となる。

- 0〜7キーは「描画色選択キー」となり、ドットの描画はされない
- マウスで編集エリアをクリックする事で、その位置にドットが描画される


### ファイルの入出力メニュー
ファイルの入出力メニューも画面外に設置し、そこでファイルの読み込み、保存が可能になる。


